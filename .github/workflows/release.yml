name: Release and Publish Docker Image

on:
  push:
    branches:
      - main
    paths:
      - 'package.json'
      - 'src/**'
      - 'Dockerfile'
      - 'tsconfig.json'
      - 'tsconfig.prod.json'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: read

jobs:
  check-version:
    name: Check Version Change
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      version_changed: ${{ steps.version_check.outputs.changed }}
      current_version: ${{ steps.version_check.outputs.version }}
      should_build: ${{ steps.version_check.outputs.should_build }}
      is_prerelease: ${{ steps.version_check.outputs.is_prerelease }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Check version change
        id: version_check
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # Check if this is a prerelease (contains hyphen like 1.2.0-beta.1)
          if [[ "$CURRENT_VERSION" == *"-"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi
          
          # Always build on manual trigger (workflow_dispatch)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "ðŸš€ Manual trigger - building version $CURRENT_VERSION"
            exit 0
          fi
          
          # For push events, check if we have a parent commit
          if ! git rev-parse HEAD^ >/dev/null 2>&1; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "ðŸŽ‰ Initial commit - building version $CURRENT_VERSION"
            exit 0
          fi
          
          # Check if package.json changed in this push
          if git diff HEAD^ HEAD --name-only | grep -q "package.json"; then
            PREV_VERSION=$(git show HEAD^:package.json | node -p "JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8')).version")
            
            if [ "$CURRENT_VERSION" != "$PREV_VERSION" ]; then
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "âœ… Version changed from $PREV_VERSION to $CURRENT_VERSION"
            else
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "should_build=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ Version unchanged: $CURRENT_VERSION"
            fi
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ package.json not modified in this push"
          fi

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    outputs:
      digest: ${{ steps.build.outputs.digest }}
    permissions:
      contents: write      # Required for creating releases and tags
      packages: write      # Required for pushing to GHCR
      id-token: write      # Required for OIDC/Sigstore keyless signing
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        env:
          # CRITICAL: Set annotations on both manifest AND index level for GHCR
          # GHCR reads description from manifest-index for multi-arch images
          DOCKER_METADATA_ANNOTATIONS_LEVELS: manifest,index
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.check-version.outputs.current_version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.check-version.outputs.current_version }}
            type=semver,pattern={{major}},value=${{ needs.check-version.outputs.current_version }}
            type=raw,value=latest,enable=${{ needs.check-version.outputs.is_prerelease == 'false' }}
          labels: |
            org.opencontainers.image.title=Komodo MCP Server
            org.opencontainers.image.description=Model Context Protocol server for Komodo Container Manager
            org.opencontainers.image.version=${{ needs.check-version.outputs.current_version }}
            org.opencontainers.image.vendor=MP-Tool
            org.opencontainers.image.licenses=GPL-3.0
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.documentation=https://github.com/${{ github.repository }}#readme
          annotations: |
            org.opencontainers.image.title=Komodo MCP Server
            org.opencontainers.image.description=Model Context Protocol server for Komodo Container Manager
            org.opencontainers.image.version=${{ needs.check-version.outputs.current_version }}
            org.opencontainers.image.vendor=MP-Tool
            org.opencontainers.image.licenses=GPL-3.0
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.documentation=https://github.com/${{ github.repository }}#readme

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          # Multi-architecture support:
          # - linux/amd64:    Standard x86_64 servers and desktops
          # - linux/arm64:    Apple Silicon, AWS Graviton, Raspberry Pi 4/5
          # - linux/arm/v7:   Raspberry Pi 3, older 32-bit ARM devices
          # - linux/arm/v6:   Raspberry Pi Zero/1, lightweight IoT devices
          # Note: GHCR shows an additional "unknown/unknown" entry - this is the SLSA
          # attestation manifest (provenance + SBOM metadata), not a runnable image.
          # This is expected OCI behavior and required for supply chain security.
          platforms: linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6
          push: true
          target: production
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          annotations: ${{ steps.meta.outputs.annotations }}
          # Build-time metadata embedded into the image
          build-args: |
            VERSION=${{ needs.check-version.outputs.current_version }}
            BUILD_DATE=${{ github.event.repository.updated_at }}
            COMMIT_SHA=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

      # Sign the Docker image using Sigstore keyless signing
      # This creates a cryptographic signature that proves the image was built in this workflow
      - name: Sign Docker image with Cosign
        env:
          DIGEST: ${{ steps.build.outputs.digest }}
          TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          images=""
          for tag in ${TAGS}; do
            images+="${tag}@${DIGEST} "
          done
          cosign sign --yes ${images}

      - name: Export attestations for release
        env:
          DIGEST: ${{ steps.build.outputs.digest }}
        run: |
          cosign download attestation ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${DIGEST} > attestations.intoto.jsonl

      - name: Generate release notes
        id: release_notes
        env:
          VERSION: ${{ needs.check-version.outputs.current_version }}
          DIGEST: ${{ steps.build.outputs.digest }}
        run: |
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f1,2)
          
          cat > release_notes.md << 'EOF'
          ## Changelog
          EOF
          
          # Extract changelog section
          if grep -q "^## \[${VERSION}\]" CHANGELOG.md; then
            sed -n "/^## \[${VERSION}\]/,/^## \[/p" CHANGELOG.md | sed '1d;$d' | sed '$d' >> release_notes.md
          else
            echo "_No changelog entry for this version._" >> release_notes.md
          fi
          
          cat >> release_notes.md << EOF
          
          ## Installation
          
          \`\`\`bash
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}
          \`\`\`
          
          **Tags:** \`latest\` \`${VERSION}\` \`${MINOR}\` \`${MAJOR}\`
          
          **Platforms:** \`amd64\` \`arm64\` \`arm/v7\` \`arm/v6\`
          
          <details>
          <summary>Verify image signature</summary>
          
          \`\`\`bash
          cosign verify ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION} \\
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \\
            --certificate-identity-regexp=https://github.com/${{ github.repository }}
          \`\`\`
          
          **Digest:** \`${DIGEST}\`
          </details>
          
          ---
          [Documentation](https://github.com/${{ github.repository }}#readme) Â· [Examples](https://github.com/${{ github.repository }}/tree/main/examples) Â· [Full Changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          EOF

      # Create signed annotated tag using GitHub API
      # This creates a verified tag that shows as "Verified" in GitHub UI
      - name: Create signed tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.check-version.outputs.current_version }}
          DIGEST: ${{ steps.build.outputs.digest }}
        run: |
          # Create annotated tag via GitHub API (automatically signed by GitHub)
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/git/tags \
            -f tag="${VERSION}" \
            -f message="Release ${VERSION}

          Docker Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}
          Digest: ${DIGEST}
          
          Signed-off-by: GitHub Actions <actions@github.com>" \
            -f object="${{ github.sha }}" \
            -f type="commit" \
            | jq -r '.sha' > tag_sha.txt
          
          # Create tag reference
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/git/refs \
            -f ref="refs/tags/${VERSION}" \
            -f sha="$(cat tag_sha.txt)" || true  # Ignore if tag already exists

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-version.outputs.current_version }}
          name: ${{ needs.check-version.outputs.current_version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ needs.check-version.outputs.is_prerelease == 'true' }}
          # Attach attestation for OpenSSF Scorecard Signed-Releases check
          files: attestations.intoto.jsonl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Release Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [check-version, build-and-push]
    if: needs.check-version.outputs.should_build == 'true'
    steps:
      - name: Summary
        env:
          VERSION: ${{ needs.check-version.outputs.current_version }}
          DIGEST: ${{ needs.build-and-push.outputs.digest }}
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âœ… Release ${VERSION}
          
          | | |
          |---|---|
          | **Image** | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}\` |
          | **Digest** | \`${DIGEST}\` |
          | **Platforms** | \`linux/amd64\`, \`linux/arm64\` |
          
          
          [View Release](https://github.com/${{ github.repository }}/releases/tag/${VERSION}) Â· [Docker Image](https://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }})
          EOF
